<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample Size Calculator - ResearchToolsLab</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1a2e;
    --paper: #f0f4f8;
    --cream: #e2e8f0;
    --accent: #4f46e5;
    --accent-hover: #4338ca;
    --accent2: #0ea5e9;
    --muted: #64748b;
    --border: #cbd5e1;
    --success: #10b981;
    --card: #ffffff;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --radius: 16px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--paper);
    color: var(--ink);
    font-size: 16px;
    line-height: 1.6;
    min-height: 100vh;
  }

  .site-header {
    background: var(--ink);
    padding: 0.9rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 12px rgba(0,0,0,0.15);
  }

  .site-header .logo {
    color: #fff;
    font-size: 1.25rem;
    font-weight: 700;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .site-header .logo span {
    background: var(--accent);
    color: #fff;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  .back-home {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    font-size: 0.88rem;
    font-weight: 500;
    padding: 0.45rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    transition: all 0.2s;
  }

  .back-home:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border-color: rgba(255,255,255,0.3);
  }

  .back-home svg { width: 16px; height: 16px; }

  .page-container {
    max-width: 720px;
    margin: 0 auto;
    padding: 2rem 1.5rem 3rem;
  }

  .page-title { text-align: center; margin-bottom: 2rem; }

  .page-title h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(1.6rem, 4vw, 2.2rem);
    color: var(--ink);
    margin-bottom: 0.4rem;
    font-weight: 400;
  }

  .page-title p {
    color: var(--muted);
    font-size: 0.92rem;
    max-width: 500px;
    margin: 0 auto;
  }

  .tool-card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 1.75rem;
    border: 1px solid var(--border);
  }

  .steps {
    display: flex;
    gap: 0;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--cream);
    overflow-x: auto;
  }

  .step-tab {
    padding: 0.75rem 1.25rem;
    font-size: 0.82rem;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    white-space: nowrap;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: none;
    font-family: 'Outfit', sans-serif;
  }

  .step-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .step-tab .sn {
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--cream); color: var(--muted);
    font-size: 0.7rem; display: flex; align-items: center;
    justify-content: center; font-weight: 600; transition: all 0.2s;
  }
  .step-tab.active .sn { background: var(--accent); color: white; }
  .step-tab.done .sn { background: var(--success); color: white; }
  .step-tab.done .sn::after { content: '‚úì'; }
  .step-tab.done .sn-txt { display: none; }

  .panel { display: none; }
  .panel.active { display: block; animation: fadeIn 0.25s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @media (prefers-reduced-motion: reduce) {
    .panel.active, .rh-num { animation: none !important; }
  }

  .study-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  @media (max-width: 480px) { .study-grid { grid-template-columns: 1fr; } }

  .study-card {
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.18s;
    background: white;
  }
  .study-card:hover { border-color: var(--accent); box-shadow: 0 2px 12px rgba(79,70,229,0.1); }
  .study-card.selected { border-color: var(--accent); background: rgba(79,70,229,0.04); }
  .study-card:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

  .sc-icon { font-size: 1.3rem; margin-bottom: 0.35rem; }
  .sc-title { font-size: 0.88rem; font-weight: 600; margin-bottom: 0.15rem; }
  .sc-desc { font-size: 0.74rem; color: var(--muted); line-height: 1.4; }

  .form-row { margin-bottom: 1.2rem; }

  label {
    display: block;
    font-size: 0.84rem;
    font-weight: 500;
    margin-bottom: 0.4rem;
  }
  label .hint { font-weight: 400; color: var(--muted); font-size: 0.76rem; margin-left: 0.35rem; }

  input[type="number"], select {
    width: 100%;
    padding: 0.62rem 0.9rem;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 0.93rem;
    background: white;
    color: var(--ink);
    transition: border-color 0.18s;
    appearance: none;
  }

  select {
    font-family: 'Outfit', sans-serif;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2364748b' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.9rem center;
    padding-right: 2.5rem;
    cursor: pointer;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
  }

  .input-wrap { position: relative; }
  .input-unit {
    position: absolute; right: 0.9rem; top: 50%;
    transform: translateY(-50%); font-size: 0.78rem;
    color: var(--muted); font-family: 'DM Mono', monospace;
    pointer-events: none;
  }

  .slider-row { display: grid; grid-template-columns: 1fr 50px; gap: 0.75rem; align-items: center; }

  input[type="range"] {
    width: 100%; height: 5px;
    background: var(--cream); border-radius: 4px;
    appearance: none; cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    appearance: none; width: 20px; height: 20px; border-radius: 50%;
    background: var(--accent); cursor: pointer;
    box-shadow: 0 2px 6px rgba(79,70,229,0.35);
  }
  input[type="range"]::-moz-range-thumb {
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--accent); cursor: pointer; border: none;
    box-shadow: 0 2px 6px rgba(79,70,229,0.35);
  }
  .slider-val {
    font-family: 'DM Mono', monospace; font-size: 0.9rem;
    font-weight: 500; color: var(--accent); text-align: right;
  }

  .effect-helper {
    background: var(--cream); border-radius: 10px;
    padding: 0.9rem; margin-bottom: 0.6rem;
  }
  .effect-helper p { font-size: 0.78rem; color: var(--muted); margin-bottom: 0.5rem; }
  .effect-opts { display: flex; gap: 0.5rem; }
  .effect-btn {
    flex: 1; padding: 0.45rem 0.25rem;
    border: 1.5px solid var(--border); border-radius: 8px;
    background: white; cursor: pointer;
    font-size: 0.76rem; font-family: 'Outfit', sans-serif;
    font-weight: 500; transition: all 0.18s; text-align: center;
  }
  .effect-btn.active { border-color: var(--accent2); color: var(--accent2); background: rgba(14,165,233,0.06); }
  .effect-btn .ev { display: block; font-family: 'DM Mono', monospace; font-size: 0.88rem; font-weight: 600; }
  .effect-btn .el { color: var(--muted); font-size: 0.68rem; }

  .slabel {
    font-size: 0.72rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--muted); margin-bottom: 1rem;
  }

  .cond { display: none; }
  .cond.show { display: block; }

  .warn-box {
    background: rgba(79,70,229,0.06);
    border: 1px solid rgba(79,70,229,0.18);
    border-radius: 10px; padding: 0.75rem 1rem;
    font-size: 0.8rem; color: var(--muted);
    line-height: 1.5; margin-bottom: 1.2rem;
  }
  .warn-box strong { color: var(--accent); }

  .err {
    background: rgba(239,68,68,0.08);
    border: 1px solid rgba(239,68,68,0.2);
    border-radius: 10px; padding: 0.7rem 1rem;
    font-size: 0.84rem; color: #dc2626;
    display: none; margin-bottom: 1rem;
  }

  .nav-btns { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

  .btn-back {
    padding: 0.75rem 1.25rem;
    background: var(--cream); color: var(--ink);
    border: none; border-radius: 10px;
    font-family: 'Outfit', sans-serif; font-size: 0.9rem;
    font-weight: 500; cursor: pointer; transition: all 0.18s;
  }
  .btn-back:hover { background: var(--border); }

  .btn-next {
    flex: 1; padding: 0.75rem;
    background: var(--accent); color: #fff;
    border: none; border-radius: 10px;
    font-family: 'Outfit', sans-serif; font-size: 0.9rem;
    font-weight: 600; cursor: pointer; transition: all 0.18s;
  }
  .btn-next:hover { background: var(--accent-hover); }

  .btn-calc {
    width: 100%; padding: 1rem;
    background: var(--accent); color: white;
    border: none; border-radius: 12px;
    font-family: 'Outfit', sans-serif; font-size: 1rem;
    font-weight: 600; cursor: pointer; transition: all 0.2s;
    margin-top: 1.5rem; letter-spacing: 0.01em;
  }
  .btn-calc:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(79,70,229,0.3); }

  .btn-reset {
    width: 100%; padding: 0.85rem;
    background: transparent; color: var(--muted);
    border: 1.5px solid var(--border); border-radius: 10px;
    font-family: 'Outfit', sans-serif; font-size: 0.88rem;
    font-weight: 500; cursor: pointer; transition: all 0.18s;
    margin-top: 0.75rem;
  }
  .btn-reset:hover { border-color: var(--accent); color: var(--accent); }

  #results { display: none; margin-top: 1.5rem; }

  .result-hero {
    background: linear-gradient(135deg, var(--ink) 0%, #2d2b55 100%);
    color: #fff;
    border-radius: var(--radius); padding: 2rem;
    text-align: center; margin-bottom: 1rem;
    position: relative; overflow: hidden;
  }
  .result-hero::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(79,70,229,0.3) 0%, transparent 70%);
  }
  .rh-label {
    font-size: 0.72rem; text-transform: uppercase;
    letter-spacing: 0.1em; color: rgba(255,255,255,0.5);
    margin-bottom: 0.4rem; position: relative;
  }
  .rh-num {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(3rem, 10vw, 5rem);
    line-height: 1; color: #fff; position: relative;
    animation: popIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(0.8); }
    to   { opacity: 1; transform: scale(1); }
  }
  .rh-unit { font-size: 0.88rem; color: rgba(255,255,255,0.5); margin-top: 0.2rem; position: relative; }
  .rh-adj {
    display: flex; align-items: center; justify-content: center;
    gap: 0.5rem; margin-top: 1rem; padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1); position: relative;
    flex-wrap: wrap;
  }
  .rh-adj-label { font-size: 0.76rem; color: rgba(255,255,255,0.45); }
  .rh-adj-num { font-family: 'DM Mono', monospace; font-size: 1.1rem; font-weight: 500; color: #a5b4fc; }

  .res-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 0.65rem; margin-bottom: 1rem;
  }
  .res-card { background: var(--cream); border-radius: 10px; padding: 0.9rem; }
  .rc-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.07em; color: var(--muted); margin-bottom: 0.25rem; }
  .rc-val { font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 500; }

  .interp {
    background: rgba(16,185,129,0.07);
    border: 1px solid rgba(16,185,129,0.2);
    border-left: 3px solid var(--success);
    border-radius: 10px; padding: 1.1rem;
    margin-bottom: 1rem;
  }
  .interp-title {
    font-size: 0.72rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.07em;
    color: var(--success); margin-bottom: 0.5rem;
  }
  .interp p { font-size: 0.88rem; line-height: 1.68; }

  .formula-box {
    background: #f8fafc; border: 1px solid var(--border);
    border-radius: 10px; padding: 1.1rem; margin-bottom: 1rem;
  }
  .fb-title {
    font-size: 0.72rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.07em;
    color: var(--muted); margin-bottom: 0.65rem;
  }
  .fb-code {
    font-family: 'DM Mono', monospace; font-size: 0.82rem;
    color: var(--ink); line-height: 1.85;
    background: white; border-radius: 8px;
    padding: 0.75rem; border: 1px solid var(--border);
    overflow-x: auto; white-space: pre;
  }
  .fb-vars { margin-top: 0.65rem; font-size: 0.76rem; color: var(--muted); line-height: 1.7; }

  .copy-block {
    background: var(--cream); border-radius: 10px;
    padding: 1.1rem; margin-bottom: 0.75rem;
  }
  .cb-header {
    font-size: 0.72rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.07em;
    color: var(--muted); margin-bottom: 0.65rem;
    display: flex; align-items: center; justify-content: space-between;
  }
  .copy-btn {
    background: var(--accent); color: #fff;
    border: none; border-radius: 6px; padding: 4px 12px;
    font-size: 0.7rem; font-family: 'Outfit', sans-serif;
    font-weight: 500; cursor: pointer; transition: all 0.18s;
  }
  .copy-btn:hover { background: var(--accent-hover); }
  .cb-text {
    font-size: 0.82rem; line-height: 1.7; color: var(--ink);
    white-space: pre-wrap; font-family: 'Outfit', sans-serif;
  }

  .attr-breakdown {
    display: grid; grid-template-columns: 1fr auto 1fr auto 1fr;
    gap: 0.5rem; margin-bottom: 1rem;
    align-items: center;
  }
  .ab-card {
    background: var(--cream); border-radius: 10px;
    padding: 0.75rem; text-align: center;
  }
  .ab-card.highlight { background: rgba(79,70,229,0.08); border: 1px solid rgba(79,70,229,0.2); }
  .ab-num { font-family: 'DM Mono', monospace; font-size: 1.1rem; font-weight: 500; color: var(--ink); }
  .ab-label { font-size: 0.68rem; color: var(--muted); margin-top: 0.15rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .ab-arrow { display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: var(--muted); }

  .site-footer {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--muted);
    font-size: 0.8rem;
    border-top: 1px solid var(--border);
    margin-top: 2rem;
  }
  .site-footer a {
    color: var(--accent);
    text-decoration: none;
  }
  .site-footer a:hover { text-decoration: underline; }

  @media (max-width: 600px) {
    .page-container { padding: 1.25rem 1rem 2rem; }
    .tool-card { padding: 1.25rem; }
    .attr-breakdown { grid-template-columns: 1fr; }
    .attr-breakdown .ab-arrow { transform: rotate(90deg); }
    .res-grid { grid-template-columns: 1fr; }
    .site-header { padding: 0.75rem 1rem; }
    .site-header .logo { font-size: 1.1rem; }
  }
</style>
</head>
<body>

<header class="site-header">
  <a href="https://freetoolhub.github.io/" class="logo">
    üî¨ ResearchToolsLab <span>FREE</span>
  </a>
  <a href="https://freetoolhub.github.io/" class="back-home">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
    Back to Home
  </a>
</header>

<div class="page-container">

  <div class="page-title">
    <h1>üìä Sample Size Calculator</h1>
    <p>Calculate the ideal sample size for surveys, experiments, clinical studies, and more with precise statistical formulas.</p>
  </div>

  <div class="tool-card">

    <div class="steps" role="tablist" aria-label="Calculator steps">
      <button type="button" class="step-tab active" id="tab1" role="tab" aria-selected="true" aria-controls="panel1" onclick="gotoStep(1)">
        <span class="sn"><span class="sn-txt">1</span></span> Study Type
      </button>
      <button type="button" class="step-tab" id="tab2" role="tab" aria-selected="false" aria-controls="panel2" onclick="gotoStep(2)">
        <span class="sn"><span class="sn-txt">2</span></span> Parameters
      </button>
      <button type="button" class="step-tab" id="tab3" role="tab" aria-selected="false" aria-controls="panel3" onclick="gotoStep(3)">
        <span class="sn"><span class="sn-txt">3</span></span> Adjustments
      </button>
    </div>

    <!-- PANEL 1: STUDY TYPE -->
    <div class="panel active" id="panel1" role="tabpanel" aria-labelledby="tab1">
      <div class="slabel">What kind of study are you running?</div>
      <div class="study-grid" role="radiogroup" aria-label="Study type selection">
        <div class="study-card selected" role="radio" aria-checked="true" tabindex="0" onclick="selectStudy('survey',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectStudy('survey',this)}">
          <div class="sc-icon">üìã</div>
          <div class="sc-title">Survey / Questionnaire</div>
          <div class="sc-desc">Polls, opinion surveys, customer feedback, market research</div>
        </div>
        <div class="study-card" role="radio" aria-checked="false" tabindex="0" onclick="selectStudy('experiment',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectStudy('experiment',this)}">
          <div class="sc-icon">üß™</div>
          <div class="sc-title">Experiment (Two Groups)</div>
          <div class="sc-desc">Comparing treatment vs control group, RCTs, A/B testing</div>
        </div>
        <div class="study-card" role="radio" aria-checked="false" tabindex="0" onclick="selectStudy('clinical',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectStudy('clinical',this)}">
          <div class="sc-icon">üè•</div>
          <div class="sc-title">Clinical / Health Study</div>
          <div class="sc-desc">Medical research with dichotomous or continuous endpoints</div>
        </div>
        <div class="study-card" role="radio" aria-checked="false" tabindex="0" onclick="selectStudy('correlation',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectStudy('correlation',this)}">
          <div class="sc-icon">üìà</div>
          <div class="sc-title">Correlation / Regression</div>
          <div class="sc-desc">Testing relationships between variables using Pearson's r</div>
        </div>
        <div class="study-card" role="radio" aria-checked="false" tabindex="0" onclick="selectStudy('prevalence',this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();selectStudy('prevalence',this)}">
          <div class="sc-icon">üîç</div>
          <div class="sc-title">Prevalence / Proportion</div>
          <div class="sc-desc">Estimating how common something is in a population</div>
        </div>
      </div>
      <div class="nav-btns">
        <button type="button" class="btn-next" onclick="gotoStep(2)">Next: Set Parameters ‚Üí</button>
      </div>
    </div>

    <!-- PANEL 2: PARAMETERS -->
    <div class="panel" id="panel2" role="tabpanel" aria-labelledby="tab2">
      <div class="err" id="err-msg" role="alert">Please check your inputs and try again.</div>

      <!-- SURVEY -->
      <div id="f-survey">
        <div class="slabel">Survey Parameters</div>
        <div class="form-row">
          <label for="s-conf">Confidence Level <span class="hint">How certain do you need to be?</span></label>
          <select id="s-conf">
            <option value="1.644854">90% ‚Äî Exploratory research</option>
            <option value="1.959964" selected>95% ‚Äî Standard (most research)</option>
            <option value="2.326348">98% ‚Äî Strict</option>
            <option value="2.575829">99% ‚Äî Very strict / high stakes</option>
          </select>
        </div>
        <div class="form-row">
          <label for="s-moe">Margin of Error (¬±)</label>
          <div class="slider-row">
            <input type="range" id="s-moe" min="1" max="20" value="5" step="0.5" oninput="sv('s-moe-v',this.value+'%')">
            <div class="slider-val" id="s-moe-v">5%</div>
          </div>
        </div>
        <div class="form-row">
          <label for="s-prop">Population Proportion <span class="hint">Expected % with characteristic ‚Äî use 50% if unsure (most conservative)</span></label>
          <div class="slider-row">
            <input type="range" id="s-prop" min="1" max="99" value="50" step="1" oninput="sv('s-prop-v',this.value+'%')">
            <div class="slider-val" id="s-prop-v">50%</div>
          </div>
        </div>
        <div class="form-row">
          <label for="s-pop">Population Size <span class="hint">Enter 0 if very large or unknown</span></label>
          <input type="number" id="s-pop" value="0" min="0" placeholder="0 = unlimited population">
        </div>
      </div>

      <!-- EXPERIMENT -->
      <div id="f-experiment" class="cond">
        <div class="slabel">Experiment Parameters</div>
        <div class="form-row">
          <label for="e-conf">Confidence Level (Œ±)</label>
          <select id="e-conf">
            <option value="1.644854">90% (Œ± = 0.10)</option>
            <option value="1.959964" selected>95% (Œ± = 0.05) ‚Äî Standard</option>
            <option value="2.575829">99% (Œ± = 0.01)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="e-power">Statistical Power (1-Œ≤) <span class="hint">Probability of detecting a true effect</span></label>
          <select id="e-power">
            <option value="0.841621">80% ‚Äî Minimum standard</option>
            <option value="1.036433">85%</option>
            <option value="1.281552" selected>90% ‚Äî Recommended</option>
            <option value="1.644854">95% ‚Äî High power</option>
          </select>
        </div>
        <div class="form-row">
          <label for="e-eff">Effect Size (Cohen's d) <span class="hint">Standardised difference between groups</span></label>
          <div class="effect-helper">
            <p>Not sure? Select a reference size:</p>
            <div class="effect-opts">
              <button type="button" class="effect-btn" onclick="setEff('e-eff',0.2,this)"><span class="ev">0.2</span><span class="el">Small</span></button>
              <button type="button" class="effect-btn active" onclick="setEff('e-eff',0.5,this)"><span class="ev">0.5</span><span class="el">Medium</span></button>
              <button type="button" class="effect-btn" onclick="setEff('e-eff',0.8,this)"><span class="ev">0.8</span><span class="el">Large</span></button>
            </div>
          </div>
          <div class="input-wrap">
            <input type="number" id="e-eff" value="0.5" step="0.01" min="0.01" placeholder="e.g. 0.5">
            <span class="input-unit">d</span>
          </div>
        </div>
        <div class="form-row">
          <label for="e-tails">Test Type</label>
          <select id="e-tails">
            <option value="2" selected>Two-tailed (most common ‚Äî no directional hypothesis)</option>
            <option value="1">One-tailed (directional hypothesis specified)</option>
          </select>
        </div>
      </div>

      <!-- CLINICAL -->
      <div id="f-clinical" class="cond">
        <div class="slabel">Clinical Study Parameters</div>
        <div class="form-row">
          <label for="c-ep">Primary Endpoint Type</label>
          <select id="c-ep" onchange="toggleClinicalEP()">
            <option value="proportion">Dichotomous (yes/no outcome ‚Äî e.g. mortality, pregnancy)</option>
            <option value="continuous">Continuous (means ‚Äî e.g. blood pressure, weight loss)</option>
          </select>
        </div>
        <div id="c-prop-fields">
          <div class="form-row">
            <label for="c-p1">Event Rate ‚Äî Control Group (p‚ÇÅ)</label>
            <div class="input-wrap">
              <input type="number" id="c-p1" value="0.30" step="0.01" min="0.01" max="0.99">
              <span class="input-unit">p‚ÇÅ</span>
            </div>
          </div>
          <div class="form-row">
            <label for="c-p2">Event Rate ‚Äî Treatment Group (p‚ÇÇ) <span class="hint">Expected rate after intervention</span></label>
            <div class="input-wrap">
              <input type="number" id="c-p2" value="0.50" step="0.01" min="0.01" max="0.99">
              <span class="input-unit">p‚ÇÇ</span>
            </div>
          </div>
        </div>
        <div id="c-cont-fields" class="cond">
          <div class="form-row">
            <label for="c-m1">Mean ‚Äî Control Group (Œº‚ÇÅ)</label>
            <input type="number" id="c-m1" value="100" step="0.1">
          </div>
          <div class="form-row">
            <label for="c-m2">Mean ‚Äî Treatment Group (Œº‚ÇÇ)</label>
            <input type="number" id="c-m2" value="110" step="0.1">
          </div>
          <div class="form-row">
            <label for="c-sd">Pooled Standard Deviation (œÉ)</label>
            <div class="input-wrap">
              <input type="number" id="c-sd" value="20" step="0.1" min="0.01">
              <span class="input-unit">œÉ</span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <label for="c-alpha">Significance Level (Œ±)</label>
          <select id="c-alpha">
            <option value="1.959964" selected>0.05 ‚Äî Standard</option>
            <option value="2.575829">0.01 ‚Äî Strict</option>
          </select>
        </div>
        <div class="form-row">
          <label for="c-power">Power (1-Œ≤)</label>
          <select id="c-power">
            <option value="0.841621" selected>80%</option>
            <option value="1.281552">90%</option>
          </select>
        </div>
        <div class="form-row">
          <label for="c-ratio">Enrollment Ratio (n‚ÇÇ/n‚ÇÅ) <span class="hint">Participants in treatment per each in control</span></label>
          <select id="c-ratio">
            <option value="1" selected>1:1 ‚Äî Equal groups</option>
            <option value="2">1:2 ‚Äî Twice as many in treatment</option>
            <option value="0.5">2:1 ‚Äî Twice as many in control</option>
          </select>
        </div>
      </div>

      <!-- CORRELATION -->
      <div id="f-correlation" class="cond">
        <div class="slabel">Correlation Study Parameters</div>
        <div class="form-row">
          <label for="r-val">Expected Pearson Correlation Coefficient (r)</label>
          <div class="effect-helper">
            <p>Not sure? Select a reference:</p>
            <div class="effect-opts">
              <button type="button" class="effect-btn" onclick="setEff('r-val',0.1,this)"><span class="ev">0.1</span><span class="el">Weak</span></button>
              <button type="button" class="effect-btn active" onclick="setEff('r-val',0.3,this)"><span class="ev">0.3</span><span class="el">Moderate</span></button>
              <button type="button" class="effect-btn" onclick="setEff('r-val',0.5,this)"><span class="ev">0.5</span><span class="el">Strong</span></button>
            </div>
          </div>
          <div class="input-wrap">
            <input type="number" id="r-val" value="0.3" step="0.01" min="0.01" max="0.99">
            <span class="input-unit">r</span>
          </div>
        </div>
        <div class="form-row">
          <label for="r-alpha">Significance Level (Œ±)</label>
          <select id="r-alpha">
            <option value="1.959964" selected>0.05</option>
            <option value="2.575829">0.01</option>
          </select>
        </div>
        <div class="form-row">
          <label for="r-power">Power (1-Œ≤)</label>
          <select id="r-power">
            <option value="0.841621" selected>80%</option>
            <option value="1.281552">90%</option>
          </select>
        </div>
      </div>

      <!-- PREVALENCE -->
      <div id="f-prevalence" class="cond">
        <div class="slabel">Prevalence Study Parameters</div>
        <div class="form-row">
          <label for="pv-prev">Expected Prevalence <span class="hint">Your best estimate of how common the condition is</span></label>
          <div class="slider-row">
            <input type="range" id="pv-prev" min="1" max="99" value="20" step="1" oninput="sv('pv-prev-v',this.value+'%')">
            <div class="slider-val" id="pv-prev-v">20%</div>
          </div>
        </div>
        <div class="form-row">
          <label for="pv-prec">Precision (¬±) <span class="hint">Acceptable margin of error around prevalence estimate</span></label>
          <div class="slider-row">
            <input type="range" id="pv-prec" min="1" max="15" value="5" step="0.5" oninput="sv('pv-prec-v',this.value+'%')">
            <div class="slider-val" id="pv-prec-v">5%</div>
          </div>
        </div>
        <div class="form-row">
          <label for="pv-conf">Confidence Level</label>
          <select id="pv-conf">
            <option value="1.644854">90%</option>
            <option value="1.959964" selected>95%</option>
            <option value="2.575829">99%</option>
          </select>
        </div>
        <div class="form-row">
          <label for="pv-pop">Population Size <span class="hint">Enter 0 if unknown or very large</span></label>
          <input type="number" id="pv-pop" value="0" min="0" placeholder="0 = unlimited">
        </div>
      </div>

      <div class="nav-btns">
        <button type="button" class="btn-back" onclick="gotoStep(1)">‚Üê Back</button>
        <button type="button" class="btn-next" onclick="gotoStep(3)">Next: Adjustments ‚Üí</button>
      </div>
    </div>

    <!-- PANEL 3: ADJUSTMENTS -->
    <div class="panel" id="panel3" role="tabpanel" aria-labelledby="tab3">
      <div class="warn-box">
        <strong>Never recruit exactly your minimum sample.</strong> Accounting for dropouts and exclusions upfront protects your study's statistical validity. Apply adjustments sequentially below.
      </div>

      <div class="slabel">Attrition & Design Adjustments</div>

      <div class="form-row">
        <label for="a-excl">Ineligibility / Screening Exclusion Rate <span class="hint">% expected to fail inclusion criteria at screening</span></label>
        <div class="slider-row">
          <input type="range" id="a-excl" min="0" max="30" value="5" step="1" oninput="sv('a-excl-v',this.value+'%')">
          <div class="slider-val" id="a-excl-v">5%</div>
        </div>
      </div>

      <div class="form-row">
        <label for="a-drop">Dropout / Non-Response Rate <span class="hint">% expected to withdraw or not respond after enrolment</span></label>
        <div class="slider-row">
          <input type="range" id="a-drop" min="0" max="50" value="15" step="1" oninput="sv('a-drop-v',this.value+'%')">
          <div class="slider-val" id="a-drop-v">15%</div>
        </div>
      </div>

      <div class="form-row">
        <label for="a-deff">Design Effect (DEFF) <span class="hint">For cluster sampling ‚Äî use 1.0 for simple random sampling</span></label>
        <div class="input-wrap">
          <input type="number" id="a-deff" value="1.0" step="0.1" min="1.0">
          <span class="input-unit">DEFF</span>
        </div>
      </div>

      <button type="button" class="btn-calc" onclick="calculate()">üìä Calculate Sample Size</button>
    </div>

    <!-- RESULTS -->
    <div id="results">

      <div class="result-hero">
        <div class="rh-label">Minimum Analysable Sample Size</div>
        <div class="rh-num" id="r-n" aria-live="polite">‚Äî</div>
        <div class="rh-unit">participants needed for valid analysis</div>
        <div class="rh-adj">
          <span class="rh-adj-label">Recruit at least</span>
          <span class="rh-adj-num" id="r-recruit">‚Äî</span>
          <span class="rh-adj-label">to account for attrition</span>
        </div>
      </div>

      <div class="attr-breakdown">
        <div class="ab-card">
          <div class="ab-num" id="r-screen">‚Äî</div>
          <div class="ab-label">Screen / Invite</div>
        </div>
        <div class="ab-arrow">‚Üí</div>
        <div class="ab-card">
          <div class="ab-num" id="r-enroll">‚Äî</div>
          <div class="ab-label">Enroll</div>
        </div>
        <div class="ab-arrow">‚Üí</div>
        <div class="ab-card highlight">
          <div class="ab-num" id="r-analyze">‚Äî</div>
          <div class="ab-label">Analysed ‚úì</div>
        </div>
      </div>

      <div class="res-grid">
        <div class="res-card">
          <div class="rc-label">Study Type</div>
          <div class="rc-val" id="r-type">‚Äî</div>
        </div>
        <div class="res-card">
          <div class="rc-label">Confidence Level</div>
          <div class="rc-val" id="r-conf">‚Äî</div>
        </div>
        <div class="res-card">
          <div class="rc-label">Exclusion Rate</div>
          <div class="rc-val" id="r-excl">‚Äî</div>
        </div>
        <div class="res-card">
          <div class="rc-label">Dropout Rate</div>
          <div class="rc-val" id="r-drop">‚Äî</div>
        </div>
      </div>

      <div class="interp">
        <div class="interp-title">üí¨ Plain English Interpretation</div>
        <p id="r-interp">‚Äî</p>
      </div>

      <div class="formula-box">
        <div class="fb-title">üìê Formula & Methodology</div>
        <div class="fb-code" id="r-formula">‚Äî</div>
        <div class="fb-vars" id="r-vars">‚Äî</div>
      </div>

      <div class="copy-block">
        <div class="cb-header">
          üìã Copy for Thesis / Ethics Application
          <button type="button" class="copy-btn" onclick="doCopy()">Copy</button>
        </div>
        <div class="cb-text" id="r-copytext">‚Äî</div>
      </div>

      <button type="button" class="btn-reset" onclick="resetAll()">‚Ü∫ Recalculate with Different Parameters</button>
    </div>

  </div>
</div>

<footer class="site-footer">
  <p>¬© 2025 <a href="https://freetoolhub.github.io/">ResearchToolsLab</a> ‚Äî Free research tools for everyone.</p>
</footer>

<script>
(function() {
  'use strict';

  var Z_LABELS = {
    '1.644854': '90%',
    '1.959964': '95%',
    '2.326348': '98%',
    '2.575829': '99%'
  };
  var POWER_LABELS = {
    '0.841621': '80%',
    '1.036433': '85%',
    '1.281552': '90%',
    '1.644854': '95%'
  };
  var ONE_TAIL_Z = {
    '1.644854': 1.281552,
    '1.959964': 1.644854,
    '2.575829': 2.326348
  };

  var study = 'survey';

  function sv(id, val) { document.getElementById(id).textContent = val; }
  function g(id) { return document.getElementById(id); }
  function gv(id) { return parseFloat(g(id).value); }
  function getZLabel(selId) { return Z_LABELS[g(selId).value] || '95%'; }
  function getPowerLabel(selId) { return POWER_LABELS[g(selId).value] || '80%'; }
  function clampMin(v, min, fb) { return (isNaN(v) || v < min) ? fb : v; }

  window.sv = sv;

  window.setEff = function(targetId, val, btn) {
    btn.closest('.effect-opts').querySelectorAll('.effect-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    g(targetId).value = val;
  };

  window.selectStudy = function(type, el) {
    document.querySelectorAll('.study-card').forEach(function(c) {
      c.classList.remove('selected');
      c.setAttribute('aria-checked', 'false');
    });
    el.classList.add('selected');
    el.setAttribute('aria-checked', 'true');
    study = type;
    g('results').style.display = 'none';
  };

  window.toggleClinicalEP = function() {
    var ep = g('c-ep').value;
    g('c-prop-fields').style.display = ep === 'proportion' ? 'block' : 'none';
    if (ep === 'continuous') {
      g('c-cont-fields').classList.add('show');
    } else {
      g('c-cont-fields').classList.remove('show');
    }
  };

  window.gotoStep = function(n) {
    [1,2,3].forEach(function(i) {
      var tab = g('tab'+i);
      tab.classList.remove('active','done');
      tab.setAttribute('aria-selected', 'false');
      if (i < n) tab.classList.add('done');
      if (i === n) {
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
      }
      g('panel'+i).classList.remove('active');
    });
    g('panel'+n).classList.add('active');
    if (n < 3) g('results').style.display = 'none';
    if (n === 2) {
      ['survey','experiment','clinical','correlation','prevalence'].forEach(function(t) {
        var el = g('f-'+t);
        if (t === study) { el.classList.remove('cond'); el.style.display = 'block'; }
        else { el.classList.add('cond'); el.style.display = 'none'; }
      });
    }
  };

  function showErr(msg) {
    var el = g('err-msg');
    el.textContent = msg || 'Please check your inputs.';
    el.style.display = 'block';
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
  function hideErr() { g('err-msg').style.display = 'none'; }

  window.calculate = function() {
    hideErr();

    var excl = Math.max(0, Math.min(gv('a-excl') / 100, 0.99));
    var drop = Math.max(0, Math.min(gv('a-drop') / 100, 0.99));
    var deff = clampMin(gv('a-deff'), 1.0, 1.0);

    var n = 0, confLabel = '', powerLabel = '';
    var formulaText = '', formulaVars = '', interpretation = '';
    var isPerGroup = false;
    var totalParticipants = 0;

    // ‚îÄ‚îÄ SURVEY ‚îÄ‚îÄ
    if (study === 'survey') {
      var z = gv('s-conf');
      var moe = gv('s-moe') / 100;
      var p = gv('s-prop') / 100;
      var N = Math.max(0, Math.floor(gv('s-pop') || 0));

      var n0 = (z * z * p * (1 - p)) / (moe * moe);
      n0 = n0 * deff;

      if (N > 0) {
        n = Math.ceil(n0 / (1 + (n0 - 1) / N));
      } else {
        n = Math.ceil(n0);
      }

      confLabel = getZLabel('s-conf');
      totalParticipants = n;

      formulaText =
        'n‚ÇÄ = (z¬≤ √ó p √ó (1‚àíp)) / e¬≤\n' +
        '   = (' + z.toFixed(6) + '¬≤ √ó ' + p + ' √ó ' + (1-p).toFixed(2) + ') / ' + moe + '¬≤\n' +
        '   = ' + Math.ceil((z*z*p*(1-p))/(moe*moe)) +
        (deff > 1 ? '\n\nDesign Effect: n‚ÇÄ √ó ' + deff + ' = ' + Math.ceil((z*z*p*(1-p))/(moe*moe) * deff) : '') +
        (N > 0 ? '\n\nFinite Population Correction (N = ' + N.toLocaleString() + '):\nn = n‚ÇÄ / (1 + (n‚ÇÄ‚àí1)/N) = ' + n : '');

      formulaVars =
        'z = ' + z.toFixed(6) + ' (' + confLabel + ' confidence z-score) | p = ' + (p*100).toFixed(0) + '% (population proportion) | e = ¬±' + (moe*100).toFixed(1) + '% (margin of error)' +
        (N > 0 ? ' | N = ' + N.toLocaleString() + ' (population size)' : '') +
        (deff > 1 ? ' | DEFF = ' + deff : '');

      interpretation =
        'Your survey requires a minimum of <strong>' + n + ' completed responses</strong> to achieve ' + confLabel + ' confidence ' +
        'that results are accurate to within ¬±' + (moe*100).toFixed(1) + ' percentage points. ' +
        (N > 0
          ? 'The finite population correction has been applied because your population (N = ' + N.toLocaleString() + ') is known and finite. '
          : 'This assumes an effectively unlimited population. ') +
        'Using p = ' + (p*100).toFixed(0) + '% gives the most conservative estimate.';
    }

    // ‚îÄ‚îÄ EXPERIMENT ‚îÄ‚îÄ
    else if (study === 'experiment') {
      var z_a_raw = g('e-conf').value;
      var z_a = gv('e-conf');
      var z_b = gv('e-power');
      var d = gv('e-eff');
      var tails = parseInt(g('e-tails').value);

      if (!d || d <= 0) { showErr('Effect size must be greater than 0.'); return; }

      var za_final = tails === 2 ? z_a : (ONE_TAIL_Z[z_a_raw] || z_a * 0.8);

      n = Math.ceil(2 * Math.pow((za_final + z_b) / d, 2) * deff);
      isPerGroup = true;
      totalParticipants = n * 2;
      confLabel = getZLabel('e-conf');
      powerLabel = getPowerLabel('e-power');

      formulaText =
        'n per group = 2 √ó ((z_Œ± + z_Œ≤) / d)¬≤\n' +
        '       = 2 √ó ((' + za_final.toFixed(6) + ' + ' + z_b.toFixed(6) + ') / ' + d + ')¬≤\n' +
        '       = ' + n + ' per group ‚Üí ' + (n * 2) + ' total';

      formulaVars =
        'z_Œ± = ' + za_final.toFixed(6) + ' (' + confLabel + ', ' + tails + '-tailed) | z_Œ≤ = ' + z_b.toFixed(6) + ' (' + powerLabel + ' power) | d = ' + d + ' (Cohen\'s d)';

      interpretation =
        'Your experiment requires <strong>' + n + ' participants per group</strong> (' + (n*2).toLocaleString() + ' total across both groups) ' +
        'to detect a ' + (d >= 0.8 ? 'large' : d >= 0.5 ? 'medium' : 'small') + ' effect (Cohen\'s d = ' + d + ') ' +
        'with ' + powerLabel + ' statistical power at ' + confLabel + ' significance (' + tails + '-tailed). ' +
        'This means if the true effect of this magnitude exists, you have a ' + powerLabel + ' chance of detecting it.';
    }

    // ‚îÄ‚îÄ CLINICAL ‚îÄ‚îÄ
    else if (study === 'clinical') {
      var z_a = gv('c-alpha');
      var z_b = gv('c-power');
      var ep = g('c-ep').value;
      var ratio = gv('c-ratio');

      confLabel = getZLabel('c-alpha');
      powerLabel = getPowerLabel('c-power');
      isPerGroup = true;

      if (ep === 'proportion') {
        var p1 = gv('c-p1'), p2 = gv('c-p2');
        if (isNaN(p1) || p1 <= 0 || p1 >= 1 || isNaN(p2) || p2 <= 0 || p2 >= 1) { showErr('Event rates must be between 0.01 and 0.99.'); return; }
        if (Math.abs(p1 - p2) < 0.01) { showErr('Event rates must differ by at least 0.01.'); return; }

        var k = ratio;
        var numerator = Math.pow(z_a + z_b, 2) * (p1*(1-p1) + p2*(1-p2)/k);
        var denominator = Math.pow(p2 - p1, 2);
        var n1 = Math.ceil(numerator / denominator * deff);
        var n2 = Math.ceil(n1 * k);
        n = n1;
        totalParticipants = n1 + n2;

        formulaText =
          'n‚ÇÅ = (z_Œ± + z_Œ≤)¬≤ √ó (p‚ÇÅq‚ÇÅ + p‚ÇÇq‚ÇÇ/k) / (p‚ÇÅ‚àíp‚ÇÇ)¬≤\n' +
          '   = (' + z_a.toFixed(4) + ' + ' + z_b.toFixed(4) + ')¬≤ √ó (' + p1 + '√ó' + (1-p1).toFixed(2) + ' + ' + p2 + '√ó' + (1-p2).toFixed(2) + '/' + k + ') / (' + p2 + '‚àí' + p1 + ')¬≤\n' +
          '   = ' + n1 + ' (control)  |  n‚ÇÇ = n‚ÇÅ √ó ' + k + ' = ' + n2 + ' (treatment)\n' +
          'Total = ' + (n1 + n2);

        formulaVars = 'p‚ÇÅ = ' + p1 + ' (control rate) | p‚ÇÇ = ' + p2 + ' (treatment rate) | k = ' + k + ' (allocation ratio) | z_Œ± = ' + z_a.toFixed(4) + ' | z_Œ≤ = ' + z_b.toFixed(4);

        interpretation =
          'Your clinical study requires <strong>' + n1 + ' in the control group</strong> and <strong>' + n2 + ' in the treatment group</strong> ' +
          '(' + (n1+n2) + ' total) to detect a change in event rate from ' + (p1*100).toFixed(0) + '% to ' + (p2*100).toFixed(0) + '% ' +
          'with ' + powerLabel + ' power at ' + confLabel + ' significance' +
          (k !== 1 ? ' using ' + (k < 1 ? Math.round(1/k) + ':1' : '1:' + k) + ' allocation' : '') +
          '. Formula: Kelsey/Schlesselman (1982).';
      } else {
        var m1 = gv('c-m1'), m2 = gv('c-m2'), sd = gv('c-sd');
        if (isNaN(sd) || sd <= 0) { showErr('Standard deviation must be greater than 0.'); return; }
        if (m1 === m2) { showErr('Group means must differ.'); return; }

        var d = Math.abs(m2 - m1) / sd;
        var k = ratio;
        n = Math.ceil((1 + 1/k) * Math.pow((z_a + z_b) / d, 2) * deff);
        var n2 = Math.ceil(n * k);
        totalParticipants = n + n2;

        formulaText =
          'Cohen\'s d = |Œº‚ÇÅ‚àíŒº‚ÇÇ| / œÉ = |' + m1 + '‚àí' + m2 + '| / ' + sd + ' = ' + d.toFixed(4) + '\n' +
          'n‚ÇÅ = (1 + 1/k) √ó ((z_Œ± + z_Œ≤) / d)¬≤\n' +
          '   = (1 + 1/' + k + ') √ó ((' + z_a.toFixed(4) + ' + ' + z_b.toFixed(4) + ') / ' + d.toFixed(4) + ')¬≤\n' +
          '   = ' + n + ' (control)  |  n‚ÇÇ = ' + n2 + ' (treatment)  |  Total = ' + totalParticipants;

        formulaVars = 'Œº‚ÇÅ = ' + m1 + ' | Œº‚ÇÇ = ' + m2 + ' | œÉ = ' + sd + ' | d = ' + d.toFixed(4) + ' | k = ' + k + ' | z_Œ± = ' + z_a.toFixed(4) + ' | z_Œ≤ = ' + z_b.toFixed(4);

        interpretation =
          'Your study requires <strong>' + n + ' in the control group</strong> and <strong>' + n2 + ' in the treatment group</strong> ' +
          '(' + totalParticipants + ' total) to detect a mean difference of ' + Math.abs(m2-m1) + ' (Cohen\'s d = ' + d.toFixed(2) + ') ' +
          'with ' + powerLabel + ' power at ' + confLabel + ' significance.';
      }
    }

    // ‚îÄ‚îÄ CORRELATION ‚îÄ‚îÄ
    else if (study === 'correlation') {
      var r = gv('r-val');
      var z_a = gv('r-alpha');
      var z_b = gv('r-power');

      if (isNaN(r) || r <= 0 || r >= 1) { showErr('Correlation coefficient must be between 0.01 and 0.99.'); return; }

      confLabel = getZLabel('r-alpha');
      powerLabel = getPowerLabel('r-power');

      var zr = 0.5 * Math.log((1 + r) / (1 - r));
      n = Math.ceil((Math.pow((z_a + z_b) / zr, 2) + 3) * deff);
      totalParticipants = n;

      formulaText =
        'Fisher z-transform:  z_r = 0.5 √ó ln((1+r)/(1‚àír))\n' +
        '                   = 0.5 √ó ln((1+' + r + ')/(1‚àí' + r + ')) = ' + zr.toFixed(6) + '\n' +
        'n = ((z_Œ± + z_Œ≤) / z_r)¬≤ + 3\n' +
        '  = ((' + z_a.toFixed(6) + ' + ' + z_b.toFixed(6) + ') / ' + zr.toFixed(6) + ')¬≤ + 3\n' +
        '  = ' + n;

      formulaVars = 'r = ' + r + ' | z_r = ' + zr.toFixed(6) + ' (Fisher transform) | z_Œ± = ' + z_a.toFixed(6) + ' | z_Œ≤ = ' + z_b.toFixed(6);

      interpretation =
        'To reliably detect a ' + (r >= 0.5 ? 'strong' : r >= 0.3 ? 'moderate' : 'weak') + ' correlation of r = ' + r + ', ' +
        'you need <strong>' + n + ' participants</strong> with ' + powerLabel + ' power at ' + confLabel + ' significance. ' +
        'Fisher\'s z-transformation is used because Pearson\'s r is not normally distributed ‚Äî this is the standard approach per Cohen (1988).';
    }

    // ‚îÄ‚îÄ PREVALENCE ‚îÄ‚îÄ
    else if (study === 'prevalence') {
      var z = gv('pv-conf');
      var p = gv('pv-prev') / 100;
      var e = gv('pv-prec') / 100;
      var N = Math.max(0, Math.floor(gv('pv-pop') || 0));

      confLabel = getZLabel('pv-conf');

      var n0 = (z * z * p * (1 - p)) / (e * e) * deff;
      if (N > 0) {
        n = Math.ceil(n0 / (1 + (n0 - 1) / N));
      } else {
        n = Math.ceil(n0);
      }
      totalParticipants = n;

      formulaText =
        'n = z¬≤ √ó p √ó (1‚àíp) / e¬≤\n' +
        '  = ' + z.toFixed(6) + '¬≤ √ó ' + p + ' √ó ' + (1-p).toFixed(2) + ' / ' + e + '¬≤\n' +
        '  = ' + n +
        (N > 0 ? '\n\nFinite population correction applied (N = ' + N.toLocaleString() + ')' : '');

      formulaVars = 'z = ' + z.toFixed(6) + ' (' + confLabel + ') | p = ' + (p*100).toFixed(0) + '% | e = ¬±' + (e*100).toFixed(1) + '%' + (N > 0 ? ' | N = ' + N.toLocaleString() : '');

      interpretation =
        'To estimate a prevalence of ' + (p*100).toFixed(0) + '% with ¬±' + (e*100).toFixed(1) + '% precision at ' + confLabel + ' confidence, ' +
        'you need <strong>' + n + ' participants</strong>. ' +
        'Your result would be reported as ' + (p*100).toFixed(0) + '% (' + confLabel + ' CI: ' + ((p - e)*100).toFixed(1) + '%‚Äì' + ((p + e)*100).toFixed(1) + '%).';
    }

    if (!n || n <= 0 || !isFinite(n)) { showErr('Could not compute ‚Äî please check your inputs.'); return; }

    // Sequential attrition
    var n_analysed = n;
    var n_after_exclusions = Math.ceil(n_analysed / (1 - drop));
    var n_total_recruit = Math.ceil(n_after_exclusions / (1 - excl));

    var studyLabel = {survey:'Survey',experiment:'Experiment',clinical:'Clinical Study',correlation:'Correlation Study',prevalence:'Prevalence Study'}[study];

    g('r-n').textContent       = n_analysed.toLocaleString();
    g('r-recruit').textContent = n_total_recruit.toLocaleString();
    g('r-screen').textContent  = n_total_recruit.toLocaleString();
    g('r-enroll').textContent  = n_after_exclusions.toLocaleString();
    g('r-analyze').textContent = n_analysed.toLocaleString();
    g('r-type').textContent    = studyLabel;
    g('r-conf').textContent    = confLabel;
    g('r-excl').textContent    = (excl*100).toFixed(0) + '%';
    g('r-drop').textContent    = (drop*100).toFixed(0) + '%';
    g('r-formula').textContent = formulaText;
    g('r-vars').textContent    = 'Where: ' + formulaVars;

    var attrNote = (excl + drop) > 0
      ? ' After accounting for ' + (excl*100).toFixed(0) + '% screening exclusions and ' + (drop*100).toFixed(0) + '% dropout, screen/invite at least <strong>' + n_total_recruit + '</strong> participants.'
      : '';
    g('r-interp').innerHTML = interpretation + attrNote;

    var copyText =
'SAMPLE SIZE CALCULATION ‚Äî ' + studyLabel.toUpperCase() + '\n' +
'‚îÄ'.repeat(50) + '\n' +
'Minimum Analysable Sample: ' + n_analysed + ' participants\n' +
'Screen / Invite:           ' + n_total_recruit + '\n' +
'Enroll:                    ' + n_after_exclusions + '\n' +
'Analysable (minimum):      ' + n_analysed + '\n' +
'Exclusion Rate:            ' + (excl*100).toFixed(0) + '%\n' +
'Dropout Rate:              ' + (drop*100).toFixed(0) + '%\n' +
(deff > 1 ? 'Design Effect (DEFF):      ' + deff + '\n' : '') +
'‚îÄ'.repeat(50) + '\n' +
interpretation.replace(/<\/?strong>/g, '') + attrNote.replace(/<\/?strong>/g, '') + '\n\n' +
'FORMULA USED\n' +
formulaText + '\n\n' +
'Where: ' + formulaVars + '\n\n' +
'REFERENCES\n' +
'Cochran, W.G. (1977). Sampling Techniques (3rd ed.). Wiley.\n' +
'Cohen, J. (1988). Statistical Power Analysis for the Behavioral Sciences (2nd ed.). Erlbaum.\n' +
'Schlesselman, J.J. (1982). Case-Control Studies. Oxford University Press.\n\n' +
'Calculated: ' + new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'}) + '\n' +
'Source: ResearchToolsLab Sample Size Calculator';

    g('r-copytext').textContent = copyText;

    g('results').style.display = 'block';
    g('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  window.doCopy = function() {
    navigator.clipboard.writeText(g('r-copytext').textContent).then(function() {
      var btn = document.querySelector('.copy-btn');
      btn.textContent = '‚úì Copied';
      btn.style.background = 'var(--success)';
      setTimeout(function() { btn.textContent = 'Copy'; btn.style.background = ''; }, 2200);
    }).catch(function() {
      var range = document.createRange();
      range.selectNodeContents(g('r-copytext'));
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      document.execCommand('copy');
      sel.removeAllRanges();
    });
  };

  window.resetAll = function() {
    g('results').style.display = 'none';
    gotoStep(1);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

})();
</script>
</body>
</html>